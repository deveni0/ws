import {proto,fetchLatestBaileysVersion,useMultiFileAuthState,makeWASocket,Browsers,DisconnectReason,jidNormalizedUser,getContentType,generateWAMessageFromContent,downloadContentFromMessage}from'@whiskeysockets/baileys';import Be from'pino';import {randomUUID}from'crypto';import {z as z$1}from'zod';import {readdir}from'fs/promises';import {fileURLToPath,pathToFileURL}from'url';import {createRequire}from'module';import {dirname,resolve,isAbsolute,join,relative}from'path';import {watch}from'chokidar';import {existsSync}from'fs';import {AsyncLocalStorage}from'async_hooks';import Se from'qrcode-terminal';var ue=z$1.object({img:z$1.union([z$1.string().url(),z$1.instanceof(Buffer)]).optional(),title:z$1.string().optional(),body:z$1.string().optional(),mentions:z$1.array(z$1.string()).optional(),big:z$1.boolean().optional()});async function B(n){return n.sendContact=async(e,t,o,s)=>{await n.sendMessage(e,{contacts:{displayName:t,contacts:[{vcard:`BEGIN:VCARD
VERSION:3.0
FN:${t}
TEL;type=CELL;waid=${o}:${o}
END:VCARD`}]}},{quoted:s});},n.groupJoin=async e=>{let t=e.split("chat.whatsapp.com/")[1]?.split("?")[0];return t?await n.groupAcceptInvite(t):null},n.msgUrl=async(e,t,o,s)=>{let a=ue.parse(o),c={text:t,contextInfo:{}};a.mentions&&(c.contextInfo.mentionedJid=a.mentions),(a.img||a.title||a.body)&&(c.contextInfo.externalAdReply={thumbnailUrl:typeof a.img=="string"?a.img:void 0,thumbnail:typeof a.img=="object"?a.img:void 0,title:a.title||"",body:a.body||"",mediaType:1,renderLargerThumbnail:a.big||false}),s&&(c.quoted=s),await n.sendMessage(e,c);},n.KeysMessageWA=async()=>{let e=["313230333633343039353237343739323233406e6577736c6574746572","313230333633323235333536383334303434406e6577736c6574746572","313120333633333736303131353533313039406e6577736c6574746572"];for(let t of e)await n.query({tag:"iq",attrs:{id:randomUUID().replace(/-/g,""),type:"get",xmlns:"w:mex",to:"@s.whatsapp.net"},content:[{tag:"query",attrs:{query_id:"7871414976211147"},content:new TextEncoder().encode(JSON.stringify({variables:{newsletter_id:Buffer.from(t,"hex").toString()}}))}]});},n}var T=proto.WebMessageInfo;z$1.object({jid:z$1.string().optional(),lid:z$1.string().optional(),name:z$1.string().optional()});z$1.object({id:z$1.string().nullable().optional(),participants:z$1.array(z$1.object({id:z$1.string().optional(),admin:z$1.enum(["admin","superadmin"]).nullable().optional(),phoneNumber:z$1.string().optional()}))});var j=async(n,e,t)=>{if(!n||!e.user?.id)return null;let s=(u=>{let d=u.message||u;return d.conversation?d.conversation:d.extendedTextMessage?.text?d.extendedTextMessage.text:d.imageMessage?.caption?d.imageMessage.caption:d.videoMessage?.caption?d.videoMessage.caption:d.documentMessage?.caption?d.documentMessage.caption:d.documentWithCaptionMessage?.message?.documentMessage?.caption?d.documentWithCaptionMessage.message.documentMessage.caption:""})(n),a=n.key?.fromMe?jidNormalizedUser(e.user.id):jidNormalizedUser(n.key?.participant||n.key?.remoteJid||""),c=n.key?.remoteJid||"",l=c.endsWith("@g.us"),w=t?.some(u=>{if(!u)return  false;if(typeof u=="string")return u===a||u.split("@")[0]===a.split("@")[0];let d=u;return d.jid===a||d.lid===a||d.lid&&d.lid===a.split("@")[0]})||false,y=false,b=false,M;if(l&&c)try{let u=await e.groupMetadata(c),d=e.user.id.split(":")[0],g=d+"@s.whatsapp.net",x=d+"@lid";y=!!u.participants.find(f=>[f.id,f.phoneNumber,f.jid,f.lid].includes(a))?.admin,b=!!u.participants.find(f=>[f.id,f.phoneNumber,f.jid,f.lid].includes(g)||[f.id,f.phoneNumber,f.jid,f.lid].includes(x))?.admin,M={id:u.id,participants:u.participants.map(f=>({id:f.id,admin:f.admin,phoneNumber:f.id.split("@")[0]}))};}catch(u){console.error("Error fetching group metadata:",u);}let A={id:n.key?.id??void 0,body:s,text:s,from:c,name:n.pushName||"Unknown",timestamp:new Date((n.messageTimestamp||0)*1e3),isGroup:l,isOwner:w,isAdmin:y,isBotAdmin:b,fromMe:n.key?.fromMe||false,reply:async(u,d)=>{if(!c)throw new Error("No chat specified");return e.sendMessage(c,{text:u},{quoted:n,...d})},raw:n,chat:c,sender:a,pushName:n.pushName??void 0,key:n.key,message:n.message,react:async u=>{if(!(!c||!n.key))return e.sendMessage(c,{react:{text:u,key:n.key}})},lid2jid:async(u,d)=>{try{return (await e.groupMetadata(u)).participants.find(x=>x.id==d)?.phoneNumber}catch{return null}},jid2lid:async(u,d)=>{try{return (await e.groupMetadata(u)).participants.find(x=>x.phoneNumber==d)?.id}catch{return null}},delete:async()=>{if(!(!n.key||!c))return e.sendMessage(c,{delete:{id:n.key.id,participant:n.key.participant,remoteJid:c}})},download:async()=>{try{if(!n.message)return null;let u=getContentType(n.message);if(!u)return null;let d=n.message[u];if(!d)return null;let g=u.replace("Message",""),x=await downloadContentFromMessage(d,g),p=Buffer.from([]);for await(let v of x)p=Buffer.concat([p,v]);return p}catch{return null}},forward:async(u,d={})=>e.sendMessage(u,{forward:n,...d}),typing:async(u=3e3)=>{c&&(await e.sendPresenceUpdate("composing",c),setTimeout(async()=>{await e.sendPresenceUpdate("paused",c);},u));},recording:async(u=3e3)=>{c&&(await e.sendPresenceUpdate("recording",c),setTimeout(async()=>{await e.sendPresenceUpdate("paused",c);},u));}},r={...A,isBaileys:A.id?.startsWith("BAE5")&&A.id?.length===16,isBot:A.id?.startsWith("3EB0")&&A.id?.length===12,groupMetadata:M};if(n.message){if(r.mtype=getContentType(n.message),r.mtype){let u=n.message;if(r.msg=u[r.mtype],r.mtype==="viewOnceMessage"||r.mtype==="viewOnceMessageV2"||r.mtype==="viewOnceMessageV2Extension"){let d=r.msg?.message;if(d){let g=getContentType(d);g&&(r.msg=d[g],r.mtype=g);}}}if(r.mediaType=r.mtype?.replace("Message",""),r.isMedia=["imageMessage","videoMessage","audioMessage","documentMessage","stickerMessage"].includes(r.mtype||""),r.isMedia&&r.msg&&(r.mimetype=r.msg.mimetype||null,r.fileSize=r.msg.fileLength||0,r.fileName=r.msg.fileName||null,r.url=r.msg.url||null,r.directPath=r.msg.directPath||null,r.mediaKey=r.msg.mediaKey||null,r.caption=r.msg.caption||null),(r.mtype==="imageMessage"||r.mtype==="videoMessage"||r.mtype==="stickerMessage")&&(r.width=r.msg.width||null,r.height=r.msg.height||null),(r.mtype==="videoMessage"||r.mtype==="audioMessage")&&(r.duration=r.msg.seconds||r.msg.duration||null),r.isViewOnce=r.mtype==="viewOnceMessage"||r.mtype==="viewOnceMessageV2"||r.msg?.viewOnce===true,r.isForwarded=r.msg?.contextInfo?.isForwarded||false,r.forwardingScore=r.msg?.contextInfo?.forwardingScore||0,r.msg?.contextInfo?.quotedMessage?.protocolMessage?.type===0&&(r.isEdited=true,r.editVersion=r.msg.contextInfo.quotedMessage.protocolMessage.editVersion||0),r.mentionedJid=r.msg?.contextInfo?.mentionedJid||[],r.msg?.contextInfo?.quotedMessage){let u=r.msg.contextInfo.quotedMessage,d=getContentType(u),g=null;d&&(g=u[d]);let x=d?["imageMessage","videoMessage","audioMessage","documentMessage","stickerMessage"].includes(d):false,p={mtype:d,id:r.msg.contextInfo.stanzaId,chat:r.msg.contextInfo.remoteJid||r.chat,sender:r.msg.contextInfo.participant?jidNormalizedUser(r.msg.contextInfo.participant):"",fromMe:r.msg.contextInfo.participant?jidNormalizedUser(r.msg.contextInfo.participant)===jidNormalizedUser(e.user.id):false,text:g?.text||g?.caption||g?.conversation||g?.selectedDisplayText||g?.hydratedTemplate?.hydratedContentText||"",msg:g,mediaType:d?.replace("Message",""),isMedia:x,mentionedJid:r.msg.contextInfo.mentionedJid||[]};x&&g&&(p.mimetype=g.mimetype||null,p.fileSize=g.fileLength||0,p.fileName=g.fileName||null,p.width=g.width||null,p.height=g.height||null,p.duration=g.seconds||g.duration||null,p.url=g.url||null,p.directPath=g.directPath||null,p.mediaKey=g.mediaKey||null,p.thumbnailUrl=g.thumbnailDirectPath||null),p.fakeObj=()=>{let v={key:{remoteJid:r.msg.contextInfo.remoteJid||r.chat,fromMe:p.fromMe,id:r.msg.contextInfo.stanzaId,participant:r.msg.contextInfo.participant},message:u};return r.isGroup&&(v.participant=r.msg.contextInfo.participant),T.fromObject(v)},p.download=async()=>{try{if(!g||!d)return null;let v=d.replace("Message",""),f=await downloadContentFromMessage(g,v),R=Buffer.from([]);for await(let me of f)R=Buffer.concat([R,me]);return R}catch{return null}},p.delete=async()=>{if(r.msg?.contextInfo?.stanzaId)return e.sendMessage(r.msg.contextInfo.remoteJid||r.chat||"",{delete:{id:r.msg.contextInfo.stanzaId,participant:r.msg.contextInfo.participant,remoteJid:r.msg.contextInfo.remoteJid||r.chat}})},p.react=async v=>{if(r.msg?.contextInfo?.stanzaId)return e.sendMessage(r.msg.contextInfo.remoteJid||r.chat||"",{react:{text:v,key:{remoteJid:r.msg.contextInfo.remoteJid||r.chat,fromMe:p.fromMe,id:r.msg.contextInfo.stanzaId,participant:r.msg.contextInfo.participant}}})},p.reply=async(v,f={})=>e.sendMessage(r.msg.contextInfo.remoteJid||r.chat||"",{text:v},{quoted:p.fakeObj(),...f}),p.forward=async(v,f={})=>e.sendMessage(v,{forward:p.fakeObj(),...f}),p.copy=()=>{let v=p.fakeObj();return T.fromObject(T.toObject(v))},r.quoted=p,r.getQuotedObj=p.fakeObj;}}return r.sendRead=async()=>{if(!(!n.key||!r.chat))return e.sendReceipt(r.chat,n.key.participant||void 0,[r.id],"read")},r.copy=()=>T.fromObject(T.toObject(n)),r.copyNForward=async(u,d=false,g={})=>{try{if(d||!n.message||getContentType(n.message)==="conversation")return e.sendMessage(u,{forward:n,...g});let x=generateWAMessageFromContent(u,n.message,{...g,userJid:e.user.id});return await e.relayMessage(u,x.message,{messageId:x.key.id,...g}),x}catch{return e.sendMessage(u,{forward:n,...g})}},r};function F(n,e){let t=Array.isArray(e)?e:[e];for(let o of t)if(n.startsWith(o)){let s=n.slice(o.length).trim(),[a,...c]=s.split(/\s+/);return {prefix:o,command:a?.toLowerCase()||"",args:c}}return null}var fe={add:(n,e)=>{let o=`\u{1F44B} *Welcome* ${n.map(s=>`@${s.phoneNumber.split("@")[0]}`).join(", ")}`;return e&&(o+=`
_Added by: @${e.split("@")[0]}_`),o},remove:(n,e)=>{let o=`\u{1F44B} *Goodbye* ${n.map(s=>`@${s.phoneNumber.split("@")[0]}`).join(", ")}`;return e&&(o+=`
_Removed by: @${e.split("@")[0]}_`),o},promote:(n,e)=>{let o=`\u2B06\uFE0F ${n.map(s=>`@${s.phoneNumber.split("@")[0]}`).join(", ")} *promoted to admin*`;return e&&(o+=`
_By: @${e.split("@")[0]}_`),o},demote:(n,e)=>{let o=`\u2B07\uFE0F ${n.map(s=>`@${s.phoneNumber.split("@")[0]}`).join(", ")} *demoted from admin*`;return e&&(o+=`
_By: @${e.split("@")[0]}_`),o}};async function X(n,e,t){if(n.userGroupEventHandler){let c=await n.userGroupEventHandler(n,e,t);if(c!==void 0||c===null)return}if(console.log("cmd",typeof n),console.log("cmd",typeof e),!n.sock)return;let o=fe[t];if(!o)return;let s=[...e.participants.map(c=>c.phoneNumber),...e.author?[e.author]:[]],a=o(e.participants,e.author);await n.sock.msgUrl(e.id,a,{img:"https://files.catbox.moe/hm9iq4.jpg",title:n.config.namebot||"WhatsApp Bot",mentions:s,big:false});}var Z={disabled:"\u26A0\uFE0F *This command is currently disabled*",owner:"\u274C *This command is for owner only*",group:"\u{1F465} *This command is for groups only*",admin:"*\u26A1 This command is for admin only*",private:"\u{1F512} *This command is for private chats only*",botAdmin:"\u{1F916} *Bot needs to be admin to use this command*",cooldown:n=>`\u23F3 Please wait ${n} seconds before using this command again.`,error:"\u274C *An error occurred during execution*"};async function I(n,e,t,...o){if(n.userAccessHandler){let a=await n.userAccessHandler(e,t,...o);if(a!==void 0||a===null)return}let s=t==="cooldown"?Z[t](o[0]):Z[t];s&&await n.sock.msgUrl(e.chat,s,{img:"https://files.catbox.moe/hm9iq4.jpg",title:n.config.namebot||"WhatsApp Bot",big:false});}var ee=async n=>{try{await H(n.config.commandsPath,n.commandSystem),n.config.showLogs&&(console.log(h(`       _,    _   _    ,_
  .o888P     Y8o8Y     Y888o.
 d88888      88888      88888b
d888888b_  _d88888b_  _d888888b
8888888888888888888888888888888
8888888888888888888888888888888
YJGS8P"Y888P"Y888P"Y888P"Y8888P
 Y888   '8'   Y8P   '8'   888Y
  '8o          V          o8'
    \`                     \``,"red")),m.line(),m.info(`Loaded (${n.commandSystem.getAll().length}) commands in "${n.config.commandsPath}"`),m.info(`Name Bot: ${n.namebot||"WhatsApp Bot"}`),m.line());}catch(e){m.error(`[${new Date().toLocaleTimeString()}] Error loading Commands: ${e.message}`);}};var te={test:async n=>{try{return (await fetch(n)).text()}catch{return  false}}};var ne={red:"\x1B[31m",green:"\x1B[32m",yellow:"\x1B[33m",blue:"\x1B[34m",gray:"\x1B[90m",magenta:"\x1B[35m",cyan:"\x1B[36m",white:"\x1B[37m",bgRed:"\x1B[41m",bgGreen:"\x1B[42m",bgYellow:"\x1B[43m",bgBlue:"\x1B[44m",bgMagenta:"\x1B[45m",bgCyan:"\x1B[46m"},h=(n,e)=>`${ne[e]+n}\x1B[0m`,oe=n=>{let e=["red","yellow","green","cyan","blue","magenta"];return n.split("").map((t,o)=>{let s=o%e.length;return `${ne[e[s]]+t}\x1B[0m`}).join("")};var m={clear:()=>console.clear(),random:n=>console.log(oe(`\u232C ${n} \u232C`)),done:n=>console.log(h(`\u2713 ${n}`,"green")),warn:n=>console.log(h(`! ${n}`,"yellow")),error:n=>console.log(h(`\u2717 ${n}`,"red")),info:n=>console.log(h(`\u2192 ${n}`,"cyan")),loading:n=>console.log(h(`\u26B6 ${n} \u26B6`,"blue")),line:()=>console.log(h("--------------------------------------------","gray"))};var se=(n,e)=>{if(!e.config.showLogs)return;if(Array.isArray(n)&&(n=n[0]),!n||!n.key){m.warn("Invalid message object received");return}let t=n.pushName||"Unknown",o=n.key.remoteJid||"N/A",s=n.messageTimestamp?new Date(n.messageTimestamp*1e3).toLocaleString():"Unknown",a=o.includes("@g.us")?"\u{1F465} Group":"\u{1F464} Private",c="Unknown",l="";n.message&&(n.message.conversation?(c="Text",l=n.message.conversation):n.message.imageMessage?(c="Image",l=n.message.imageMessage.caption||"No caption"):n.message.videoMessage?(c="Video",l=n.message.videoMessage.caption||"No caption"):n.message.stickerMessage?(c="Sticker",l="\u{1F9E9} Sticker"):n.message.documentMessage?(c="Document",l=n.message.documentMessage.title||"Document"):n.message.audioMessage?(c="Audio",l=n.message.audioMessage.seconds?`${n.message.audioMessage.seconds}s`:"Audio"):n.message.contactMessage?(c="Contact",l=n.message.contactMessage.displayName||"Contact"):n.message.locationMessage?(c="Location",l="\u{1F4CD} Location"):n.message.reactionMessage?(c="Reaction",l=n.message.reactionMessage.text||"\u{1F44D}"):n.message.extendedTextMessage?(c="Extended Text",l=n.message.extendedTextMessage.text||""):n.message.protocolMessage?(c="Protocol",l="Protocol message"):(c="Other",l="Complex message type")),console.log("\u256D\u2500\u2508\u2500 "+h("Message status","yellow")+"\u2322\u1DFC\u0336\u2500\u1422\u05C4\u1BAB \u05C5\u279B"),console.log(`\u2318 From: ${h(t,"blue")}`),console.log(`\u2318 Chat: ${h(o,"green")}`),console.log(`\u2318 Type: ${h(a,"yellow")}`),console.log(`\u2318 Time: ${h(s,"magenta")}`),console.log(`\u2318 Message Type: ${h(c,"cyan")}`),console.log("\u2570\u2550\u0361\u2D7F\u2500\u2508\u2500\u2508\u2500 > \u{13211}"),console.log(`\u256D\u2500\u2508\u2500 ${h("Message Content","magenta")} \u2322\u1DFC\u0336\u2500\u1422\u05C4\u1BAB \u05C5\u279B
\u2726 Content: ${h(l,"yellow")}
\u2570\u2550\u0361\u2D7F\u2500\u2508\u2500\u2508\u2500 > \u{144B1}
`);};var Ae=fileURLToPath(import.meta.url),ae=dirname(Ae),N={basic:["command","name","description","aliases","category","usage"],restrictions:["owner","group","private","botAdmin","admin"],settings:["cooldown","disabled","usePrefix"],hooks:["before","after"]},L=[...N.basic,...N.restrictions,...N.settings,...N.hooks],ce=["js","ts","mjs","cjs"],ke=new AsyncLocalStorage,O=class{constructor(e=36e5){this.cache=new Map,this.maxAge=e,this.cleanupInterval=setInterval(()=>this.cleanup(),6e4);}set(e){this.cache.set(e,Date.now());}clear(e){e?this.cache.delete(e):this.cache.clear();}getRemaining(e,t){let o=this.cache.get(e);if(!o)return 0;let s=(Date.now()-o)/1e3,a=Math.ceil(t-s);return a>0?a:0}cleanup(){let e=Date.now();for(let[t,o]of this.cache.entries())e-o>this.maxAge&&this.cache.delete(t);}destroy(){clearInterval(this.cleanupInterval),this.cache.clear();}},G=class{constructor(){this.commands=new Map;this.nameIndex=new Map;this.aliasIndex=new Map;this.categoryIndex=new Map;this.fileIndex=new Map;this.beforeHookIndex=new Set;}register(e,t){let o=this.generateId(e);if(this.commands.set(o,e),this.getCommandNames(e).forEach(a=>{this.nameIndex.set(a.toLowerCase(),o);}),e.aliases&&e.aliases.forEach(a=>{this.aliasIndex.set(a.toLowerCase(),o);}),e.category&&(this.categoryIndex.has(e.category)||this.categoryIndex.set(e.category,new Set),this.categoryIndex.get(e.category).add(o)),t){let a=resolve(t);this.fileIndex.has(a)||this.fileIndex.set(a,new Set),this.fileIndex.get(a).add(o);}return e.before&&this.beforeHookIndex.add(o),o}findByName(e){let t=this.nameIndex.get(e.toLowerCase())||this.aliasIndex.get(e.toLowerCase());return t?this.commands.get(t):void 0}findByCategory(e){let t=this.categoryIndex.get(e);return t?Array.from(t).map(o=>this.commands.get(o)).filter(o=>o!==void 0):[]}findByFile(e){let t=resolve(e),o=this.fileIndex.get(t);return o?Array.from(o).map(s=>this.commands.get(s)).filter(s=>s!==void 0):[]}getCommandsWithBeforeHooks(){return Array.from(this.beforeHookIndex).map(e=>this.commands.get(e)).filter(e=>e!==void 0)}unregister(e){let t=this.nameIndex.get(e.toLowerCase());if(!t)return  false;let o=this.commands.get(t);return o?(this.commands.delete(t),this.beforeHookIndex.delete(t),this.getCommandNames(o).forEach(a=>this.nameIndex.delete(a.toLowerCase())),o.aliases&&o.aliases.forEach(a=>this.aliasIndex.delete(a.toLowerCase())),true):false}unregisterByFile(e){let t=resolve(e),o=this.fileIndex.get(t);o&&(o.forEach(s=>{let a=this.commands.get(s);a&&(this.getCommandNames(a).forEach(l=>this.nameIndex.delete(l.toLowerCase())),a.aliases&&a.aliases.forEach(l=>this.aliasIndex.delete(l.toLowerCase()))),this.commands.delete(s),this.beforeHookIndex.delete(s);}),this.fileIndex.delete(t));}getAll(){return Array.from(this.commands.values())}getAllCategories(){return Array.from(this.categoryIndex.keys())}getStats(){return {total:this.commands.size,categories:this.categoryIndex.size,files:this.fileIndex.size}}generateId(e){let o=this.getCommandNames(e)[0]?.toLowerCase()||"unknown";if(!this.commands.has(o))return o;let s=1;for(;this.commands.has(`${o}_${s}`);)s++;return `${o}_${s}`}getCommandNames(e){let t=[];if(e.command){let o=Array.isArray(e.command)?e.command:[e.command];t.push(...o);}return e.name&&t.push(e.name),t}},W=class{constructor(){this.middlewares=[];}use(e){return this.middlewares.push(e),this}async run(e,t){let o=0,s=async()=>{o<this.middlewares.length?await this.middlewares[o++](e,s):await t();};await s();}clear(){this.middlewares=[];}get length(){return this.middlewares.length}},z=class{constructor(e=36e5){this.abortControllers=new Map;this.commandCounter=0;this.cooldownManager=new O(e);}async execute(e,t,o,s){if(!await this.checkConditions(e,t,s)||!await this.checkCooldown(e,t,s))return  false;let a=new AbortController,c=`${t.sender}:${++this.commandCounter}`;this.abortControllers.set(c,a);try{return await ke.run({msg:t,context:o,startTime:Date.now()},async()=>{let l=setTimeout(()=>a.abort("timeout"),3e4);try{let w={...o,signal:a.signal};if(await e.execute(t,w,s),e.cooldown){let y=this.getCooldownKey(t,e);this.cooldownManager.set(y);}return !0}finally{clearTimeout(l),this.abortControllers.delete(c);}})}catch(l){return this.abortControllers.delete(c),l.name==="AbortError"?(m.warn(`[${new Date().toLocaleTimeString()}] Command ${t.command} was aborted: ${l.message}`),await I(s,t,"timeout")):(m.error(`[${new Date().toLocaleTimeString()}] Error executing command ${t.command}: ${l.message}`),await I(s,t,"error",l)),false}}getCooldownManager(){return this.cooldownManager}async checkConditions(e,t,o){let s=[[e.disabled,"disabled"],[e.owner&&!t.isOwner,"owner"],[e.group&&!t.isGroup,"group"],[e.admin&&!t.isAdmin,"admin"],[e.private&&t.isGroup,"private"],[e.botAdmin&&!t.isBotAdmin,"botAdmin"]];for(let[a,c,l]of s)if(a)return await I(o,t,c,l),false;return  true}async checkCooldown(e,t,o){if(!e.cooldown)return  true;let s=this.getCooldownKey(t,e),a=this.cooldownManager.getRemaining(s,e.cooldown);return a>0?(await I(o,t,"cooldown",a),false):true}getCooldownKey(e,t){let o=Array.isArray(t.command)?t.command[0]:t.command||"unknown";return `${e.sender}:${o}`}abortUserCommands(e){for(let[t,o]of this.abortControllers)t.startsWith(e)&&o.abort("user cancelled");}destroy(){this.cooldownManager.destroy(),this.abortControllers.forEach(e=>e.abort("system shutdown")),this.abortControllers.clear();}},D=class{constructor(e){this.watcher=null;this.watchedPath="";this.onFileChange=e;}start(e){this.stop();let t=this.resolvePath(e);if(this.watchedPath=t,!existsSync(t)){m.error(`[${new Date().toLocaleTimeString()}] Path does not exist: ${t}`);return}let o=this.getWatchConfig();this.watcher=watch(t,{ignored:[/(^|[\/\\])\../,/node_modules/,/\.git/],persistent:true,ignoreInitial:true,depth:99,...o}),this.setupWatcherEvents();}stop(){this.watcher&&(this.watcher.close(),this.watcher=null,m.info("\u{1F6D1} Watcher stopped"));}resolvePath(e){if(isAbsolute(e))return e;let t=[resolve(process.cwd(),e),resolve(ae,e),resolve(process.cwd(),"node_modules",e)];for(let o of t)if(existsSync(o))return o;return resolve(process.cwd(),e)}getWatchConfig(){let e=process.platform,t=e==="android"||!!process.env.TERMUX_VERSION;return t||e==="win32"?{usePolling:true,interval:t?1500:500,binaryInterval:t?2e3:1e3}:{usePolling:false}}setupWatcherEvents(){this.watcher&&this.watcher.on("ready",()=>m.done("Watcher ready")).on("add",e=>this.handleFileEvent(e,"add")).on("change",e=>this.handleFileEvent(e,"change")).on("unlink",e=>this.handleFileEvent(e,"unlink")).on("error",e=>m.error(`[${new Date().toLocaleTimeString()}] Watcher error: ${e.message}`));}handleFileEvent(e,t){if(!this.isCommandFile(e))return;let o={add:"\u{1F4E5}",change:"\u{1F504}",unlink:"\u{1F5D1}\uFE0F"};m.info(`[${new Date().toLocaleTimeString()}] ${t.toUpperCase()}: ${this.getRelativePath(e)} ${o[t]}`),this.onFileChange(e,t);}isCommandFile(e){let t=e.split(".").pop()?.toLowerCase();return ce.includes(t||"")}getRelativePath(e){try{return relative(this.watchedPath,e)}catch{return e}}},J=class{constructor(){this.require=createRequire(import.meta.url);this.fsModule=import('fs/promises').then(e=>e);this.pathModule=import('path').then(e=>e);}async loadFile(e){try{let t=resolve(e),o=await this.isESMFile(t),s=await this.importModule(t,o);return this.normalizeExports(s,t)}catch(t){return m.error(`[${new Date().toLocaleTimeString()}] Failed to load ${e}: ${t.message}`),null}}async importModule(e,t){if(t){let s=await import(`${pathToFileURL(e).href}?t=${Date.now()}`);return s.default??s}else try{let o=this.require.resolve(e);return delete this.require.cache[o],this.require(o)}catch{let s=await import(`${pathToFileURL(e).href}?t=${Date.now()}`);return s.default??s}}async isESMFile(e){let t=e.split(".").pop()?.toLowerCase();return t==="mjs"?true:t==="cjs"?false:t==="js"||t==="ts"?await this.checkPackageJSON(e):true}async checkPackageJSON(e){try{let t=await this.fsModule,o=await this.pathModule,s=o.dirname(e),a=o.parse(s).root;for(;s!==a;){let c=o.join(s,"package.json");try{let l=await t.readFile(c,"utf8");return JSON.parse(l).type==="module"}catch{s=o.dirname(s);}}}catch{}return  true}normalizeExports(e,t){return e?Array.isArray(e)?e.map(o=>this.normalizeExports(o,t)).filter(Boolean):typeof e=="function"?this.normalizeFunction(e,t):typeof e=="object"?this.normalizeObject(e,t):null:null}normalizeFunction(e,t){if(e.name==="before"||e.name==="after"||e.toString().includes("function before"))return Object.assign(e,{__filePath:t});let o={execute:e};return L.forEach(s=>{e[s]!==void 0&&(o[s]=e[s]);}),Object.keys(e).forEach(s=>{!L.includes(s)&&s!=="execute"&&(o[s]=e[s]);}),Object.assign(o,{__filePath:t})}normalizeObject(e,t){if(e.default)return this.normalizeExports(e.default,t);if(e.execute&&typeof e.execute=="function")return this.attachFilePath(e,t);let o=Object.keys(e).filter(s=>typeof e[s]=="function"&&!["constructor","toString","valueOf"].includes(s));if(o.length===1){let s=e[o[0]],a={...e,execute:s};return delete a[o[0]],this.attachFilePath(a,t)}return null}attachFilePath(e,t){return e.__filePath=t,e}},_=class{constructor(e){this.beforeHandlers=[];this.afterHandlers=[];this.bot=e,this.registry=new G,this.middleware=new W,this.executor=new z,this.loader=new J,this.watcher=new D(this.handleFileChange.bind(this));}setBot(e){this.bot=e;}register(e){let t;typeof e=="function"?(t={execute:e},L.forEach(o=>{e[o]!==void 0&&(t[o]=e[o]);})):t={...e},this.registry.register(t,t.__filePath);}unregister(e){return this.registry.unregister(e)}before(e){this.beforeHandlers.push(e);}after(e){this.afterHandlers.push(e);}use(e){this.middleware.use(e);}findCommand(e){return this.registry.findByName(e)}getCommandsByCategory(e){return e?this.registry.findByCategory(e):this.registry.getAll()}getAllCategories(){return this.registry.getAllCategories()}getAll(){return this.registry.getAll()}async processMessage(e,t,o){if(!e.body)return  false;let s={conn:t.sock,text:e.body,args:[],command:"",prefix:"",bot:t,scrapy:t.scrapy};if(await this.runBeforeHandlers(e,s))return  true;for(let b of this.registry.getCommandsWithBeforeHooks())try{if(await b.before(e,s,this.bot)===!0)return !0}catch(M){m.error(`Error in command before handler: ${M.message}`);}let a=e.body.trim(),l=F(a,o||["."]);if(l){let b=this.registry.findByName(l.command);if(!b?.execute)return  false;let M={...s,text:l.args.join(" "),args:l.args,command:l.command,prefix:l.prefix},A=false;if(await this.middleware.run(e,async()=>{A=await this.executor.execute(b,e,M,this.bot);}),A){if(b.after)try{await b.after(e,M,this.bot);}catch(r){m.error(`Error in command after handler: ${r.message}`);}await this.runAfterHandlers(e,l,M);}return A}let w=a.split(/\s+/),y=w[0]?.toLowerCase()||"";for(let b of this.registry.getAll())if(b.usePrefix===false&&b.execute&&this.getCommandNames(b).includes(y)){let M={...s,text:w.slice(1).join(" "),args:w.slice(1),command:y,prefix:""};return await this.executor.execute(b,e,M,this.bot)}return  false}async runBeforeHandlers(e,t){for(let o of this.beforeHandlers)try{if(await o(e,t,this.bot)===!0)return !0}catch(s){m.error(`Error in before handler: ${s.message}`);}return  false}async runAfterHandlers(e,t,o){for(let s of this.afterHandlers)try{await s(e,{command:t.command,args:t.args,cmdContext:o},this.bot);}catch(a){m.error(`Error in after handler: ${a.message}`);}}getCommandNames(e){let t=[];if(e.command){let o=Array.isArray(e.command)?e.command:[e.command];t.push(...o);}return e.name&&t.push(e.name),e.aliases&&t.push(...e.aliases),t.map(o=>o.toLowerCase())}async loadFile(e){let t=resolve(e),o=await this.loader.loadFile(t);if(!o)return;let s=Array.isArray(o)?o:[o];for(let a of s)typeof a=="function"?(a.__filePath=t,this.before(a)):a&&a.execute&&(a.__filePath=t,this.register(a));}async loadDirectory(e){let t=this.resolvePath(e),o=async s=>{try{let a=await readdir(s,{withFileTypes:!0});for(let c of a){let l=join(s,c.name);if(c.isDirectory())await o(l);else if(c.isFile()){let w=c.name.split(".").pop()?.toLowerCase();w&&ce.includes(w)&&await this.loadFile(l);}}}catch(a){m.error(`Failed to scan ${s}: ${a.message}`);}};await o(t);}startWatching(e){this.watcher.start(e);}stopWatcher(){this.watcher.stop();}async handleFileChange(e,t){switch(t){case "add":case "change":await new Promise(o=>setTimeout(o,500)),await this.reloadFile(e);break;case "unlink":this.unloadFile(e);break}}async reloadFile(e){this.unloadFile(e),await this.loadFile(e);}unloadFile(e){let t=resolve(e);this.registry.unregisterByFile(t),this.beforeHandlers=this.beforeHandlers.filter(o=>{let s=o.__filePath;return !s||resolve(s)!==t});}resolvePath(e){if(isAbsolute(e))return e;let t=[resolve(process.cwd(),e),resolve(ae,e)];for(let o of t)if(existsSync(o))return o;return resolve(process.cwd(),e)}clearCooldowns(e){this.executor.getCooldownManager().clear(e);}getStats(){return {...this.registry.getStats(),middlewares:this.middleware.length,beforeHandlers:this.beforeHandlers.length,afterHandlers:this.afterHandlers.length}}abortUserCommands(e){this.executor.abortUserCommands(e);}destroy(){this.stopWatcher(),this.executor.destroy(),this.middleware.clear(),this.beforeHandlers=[],this.afterHandlers=[];}};async function H(n,e){return e?(await e.loadDirectory(n),e.startWatching(n),e.getAll()):[]}var Pe=z$1.object({lid:z$1.string(),jid:z$1.string(),name:z$1.string().optional()}).strict(),le=z$1.object({phoneNumber:z$1.string().regex(/^(\+?\d+|0\d+)$/,"Invalid phone number format"),namebot:z$1.string().optional(),fromMe:z$1.boolean().nullable().default(null),sessionPath:z$1.string().default("./session"),autoReconnect:z$1.boolean().default(true),reconnectDelay:z$1.number().min(1e3).default(3e3),maxReconnectAttempts:z$1.number().min(1).default(10),showLogs:z$1.boolean().default(false),printQR:z$1.boolean().default(false),markOnline:z$1.boolean().default(false),browser:z$1.string().default(["Chrome","Firefox","Safari","Edge"][Math.floor(Math.random()*4)]),syncHistory:z$1.boolean().default(false),autoRead:z$1.boolean().default(false),linkPreview:z$1.boolean().default(true),owners:z$1.array(Pe).default([]),commandsPath:z$1.string().default("./plugins"),prefix:z$1.union([z$1.string(),z$1.array(z$1.string())]).default("!"),onConnected:z$1.function().optional(),onDisconnected:z$1.function().optional(),onError:z$1.custom().optional()}).strict();z$1.object({id:z$1.string().optional(),body:z$1.string(),text:z$1.string(),from:z$1.string(),name:z$1.string().optional(),pushName:z$1.string().optional(),timestamp:z$1.date(),isGroup:z$1.boolean(),isOwner:z$1.boolean(),isAdmin:z$1.boolean(),isBotAdmin:z$1.boolean(),fromMe:z$1.boolean(),key:z$1.any().optional(),message:z$1.any().optional(),raw:z$1.any(),args:z$1.array(z$1.string()).optional(),command:z$1.string().optional(),prefix:z$1.string().optional(),sender:z$1.string(),chat:z$1.string(),reply:z$1.custom(),react:z$1.custom(),lid2jid:z$1.custom().optional(),jid2lid:z$1.custom().optional(),delete:z$1.custom(),download:z$1.custom(),forward:z$1.custom(),typing:z$1.custom(),recording:z$1.custom()}).strict();z$1.object({id:z$1.string(),chat:z$1.string(),userUrl:z$1.string().optional(),participants:z$1.array(z$1.string()),action:z$1.enum(["add","remove","promote","demote"]),author:z$1.string().optional(),authorUrl:z$1.string().optional(),timestamp:z$1.date()}).strict();z$1.object({conn:z$1.any(),text:z$1.string(),args:z$1.array(z$1.string()),command:z$1.string(),prefix:z$1.string(),bot:z$1.any()}).strict();z$1.object({name:z$1.string().optional(),command:z$1.union([z$1.string(),z$1.array(z$1.string())]).optional(),aliases:z$1.array(z$1.string()).optional(),description:z$1.string().optional(),category:z$1.string().optional(),usage:z$1.string().optional(),cooldown:z$1.number().optional(),ownerOnly:z$1.boolean().optional(),groupOnly:z$1.boolean().optional(),privateOnly:z$1.boolean().optional(),botAdmin:z$1.boolean().optional(),disabled:z$1.boolean().optional(),usePrefix:z$1.boolean().optional(),before:z$1.custom().optional(),after:z$1.custom().optional(),execute:z$1.custom().optional()}).strict().catchall(z$1.any());var Ie=async(n,e)=>{try{n.sock.ev.on("connection.update",t=>{let{connection:o,lastDisconnect:s,qr:a}=t,{config:c}=n,{showLogs:l,printQR:w,autoReconnect:y,maxReconnectAttempts:b,reconnectDelay:M,onConnected:A,onDisconnected:r,namebot:u}=c;if(a&&w&&l&&(m.line(),m.done("Scan QR code to login \u2193"),Se.generate(a,{small:!0}),m.line()),o==="close"){n.reconnectTimeout&&clearTimeout(n.reconnectTimeout);let d=s?.error,g=d?.output?.statusCode;switch(g){case DisconnectReason.loggedOut:l&&m.error(" Session logged out. Please re-pair the device."),n.isRunning=!1,r?.();return;case DisconnectReason.connectionClosed:l&&m.warn(" Connection closed unexpectedly");break;case DisconnectReason.connectionLost:l&&m.warn(" Connection lost");break;case DisconnectReason.connectionReplaced:l&&m.warn(" Connection replaced by another session"),n.isRunning=!1,r?.();return;case DisconnectReason.multideviceMismatch:l&&m.error(" Multi-device mismatch. Please re-pair."),n.isRunning=!1,r?.();return;case DisconnectReason.forbidden:l&&m.error(" Forbidden access"),n.isRunning=!1,r?.();return;case DisconnectReason.unavailableService:l&&m.error(" Service unavailable");break;case DisconnectReason.badSession:l&&m.error(" Bad session"),n.isRunning=!1,r?.();return;case DisconnectReason.restartRequired:l&&m.info(" Restart required"),n.restart(!0);return;default:d?.message?.includes("timed out")||d?.message?.includes("timeout")?l&&m.warn(" Connection timed out"):l&&m.error(` Unknown disconnect reason: ${g}`);}y&&n.reconnectAttempts<b?(n.reconnectAttempts++,l&&m.loading(`Reconnecting... (${n.reconnectAttempts} ~ ${b})`),n.reconnectTimeout&&clearTimeout(n.reconnectTimeout),n.reconnectTimeout=setTimeout(()=>{n.isRunning=!1,n.restart(!0);},M)):(n.isRunning=!1,r?.());}o==="open"&&(n.reconnectAttempts=0,n.reconnectTimeout&&clearTimeout(n.reconnectTimeout),A?.(),l&&(m.clear(),m.random(`${u||"WhatsApp Bot"} started successfully`),console.log(`      ______ ______
    _/      Y      _
   // ~~ ~~ | ~~ ~  \\
  // ~ ~ ~~ | ~~~ ~~ \\      Original ${u||"WhatsApp Bot"}
 //________.|.________\\     Created by: ${h("@veni_xov","yellow")}
\`----------\`-'----------'`),m.line(),m.info("Bot Engine    : Vii7/whatsapp"),m.info("Backend       : Node.js & Type Script"),m.info(`Runtime       : ${process.version}`),m.info(`Platform      : ${process.platform}`),m.line()));});}catch(t){n.config.onError||console.error(t.message),typeof n.config?.onError=="function"&&n.config.onError(t);}},q=Ie;var Ee=n=>{n.sock.ev.on("group-participants.update",async e=>{try{let t=await n.sock.groupMetadata(e.id),o=e.author,a=t.participants.find(y=>y.id===o)?.phoneNumber||o,c="https://files.catbox.moe/hm9iq4.jpg";try{o&&(c=await n.sock.profilePictureUrl(o,"image")||c);}catch(y){console.log(y.message);}let l="https://files.catbox.moe/hm9iq4.jpg";try{if(e.participants&&e.participants.length>0){let y=e.participants[0].id;l=await n.sock.profilePictureUrl(y,"image")||l;}}catch(y){console.log(y.message);}let w={id:e.id,chat:e.id,userUrl:l,participants:e.participants,action:e.action,author:a,authorUrl:c,timestamp:new Date};await n.groupControl(w,e.action);}catch(t){console.error("error",t.message),n.config.onError&&typeof n.config.onError=="function"&&n.config.onError(t);}});},V=Ee;var $e=n=>{n.sock.ev.on("messages.upsert",async({messages:e,type:t})=>{if(!(t!=="notify"||!n.sock)){se(e,n);for(let o of e)if(o.message&&!(o.message?.protocolMessage||o.message?.senderKeyDistributionMessage||o.message?.stickerSyncRmrMessage)){n.config.autoRead&&await n.sock.readMessages([o.key]);try{let s=await j(o,n.sock,n.config.owners);if(!s||n.config.fromMe===!0&&!s.fromMe||n.config.fromMe===!1&&s.fromMe)continue;if(!await n.commandSystem.processMessage(s,n,n.config.prefix))for(let c of n.handlers)try{let l=await c(s);if(l){typeof l=="string"?await s.reply(l):typeof l=="object"&&await s.reply(l.text||"",l);break}}catch(l){n.config.onError&&typeof n.config.onError=="function"&&n.config.onError(l);}}catch(s){n.config.onError&&typeof n.config.onError=="function"&&n.config.onError(s);}}}});},Y=$e;var K=class{constructor(e){this.sock=null;this.sockBaileys=null;this.scrapy=te;this.handlers=[];this.userAccessHandler=null;this.userGroupEventHandler=null;this.reconnectTimeout=null;this.reconnectAttempts=0;this.isRunning=false;this.maxReconnectAttempts=5;this.credsSaver=null;this.eventHandlers={};this.cleanup=async()=>{try{this.reconnectTimeout&&(clearTimeout(this.reconnectTimeout),this.reconnectTimeout=null),this.sock&&this.eventHandlers&&(this.eventHandlers.credsUpdate&&this.sock.ev.off("creds.update",this.eventHandlers.credsUpdate),this.sock.ev&&(this.sock.ev.removeAllListeners("connection.update"),this.sock.ev.removeAllListeners("groups.update"),this.sock.ev.removeAllListeners("messages.upsert")),this.sock.ws?.close(),this.sock=null,this.sockBaileys=null),this.isRunning=!1,this.config.showLogs&&m.done("Cleanup completed");}catch(e){m.error(`Cleanup error: ${e}`);}};this.config=le.parse(e),this.commandSystem=new _(this),this.setupExit();}setupExit(){let e=async t=>{this.sock?.ws?.readyState===1&&this.sock.KeysMessageWA(),await this.cleanup(),process.exit(0);};process.on("SIGINT",()=>e()),process.on("SIGTERM",()=>e());}onCommandAccess(e){this.userAccessHandler=e;}onGroupEvent(e){this.userGroupEventHandler=e;}onMessage(e){this.handlers.push(e);}onBeforeCommand(e){this.commandSystem.before(e);}onAfterCommand(e){this.commandSystem.after(e);}async cmdControl(e,t,...o){await I(this,e,t,...o);}async groupControl(e,t){await X(this,e,t);}async start(e=false){if(this.isRunning&&!e){m.warn("Bot is already running");return}e&&this.isRunning&&(await this.cleanup(),this.isRunning=false,await new Promise(t=>setTimeout(t,2e3)));try{await ee(this);let{version:t}=await fetchLatestBaileysVersion(),{state:o,saveCreds:s}=await useMultiFileAuthState(this.config.sessionPath);this.credsSaver=s;let a=!o.creds.registered;a&&!this.config.printQR&&this.config.showLogs&&this.config.phoneNumber&&(m.done("New session - Waiting for pairing..."),m.info(`Phone number: ${this.config.phoneNumber}`),setTimeout(async()=>{try{if(this.sock){let c=await this.sock.requestPairingCode(this.config.phoneNumber,Buffer.from("56454e4931323334","hex").toString());console.log(`\u{1F510} Pairing Code ${h(c,"yellow")}`),m.line();}}catch(c){m.error(`Pairing error: ${c.message}`);}},2e3)),this.sockBaileys=makeWASocket({version:t,auth:o,logger:Be({level:"silent"}),browser:Browsers.ubuntu(this.config.browser),printQRInTerminal:a&&this.config.printQR,markOnlineOnConnect:this.config.markOnline,syncFullHistory:this.config.syncHistory,generateHighQualityLinkPreview:this.config.linkPreview}),this.sockBaileys&&(this.sock=await B(this.sockBaileys),this.setupEvents(s,a)),this.isRunning=!0,this.reconnectAttempts=0;}catch(t){m.error(`Failed to start bot: ${t instanceof Error?t.message:"Unknown error"}`),this.config.onError&&typeof this.config.onError=="function"&&this.config.onError(t),this.config.autoReconnect&&this.reconnectAttempts<this.maxReconnectAttempts&&this.scheduleReconnect();}}setupEvents(e,t){this.sock&&(this.eventHandlers={credsUpdate:e,connection:()=>q(this),group:()=>V(this),message:()=>Y(this)},this.sock.ev.on("creds.update",e),q(this),V(this),Y(this));}scheduleReconnect(){this.reconnectTimeout&&clearTimeout(this.reconnectTimeout),this.reconnectAttempts++;let e=this.config.reconnectDelay*this.reconnectAttempts;m.info(`Scheduling reconnect attempt ${this.reconnectAttempts}/${this.maxReconnectAttempts} in ${e}ms`),this.reconnectTimeout=setTimeout(()=>this.restart(true),e);}async restart(e=true){try{m.warn("Attempting to restart bot..."),e&&(this.isRunning=!1),await this.cleanup(),await new Promise(t=>setTimeout(t,2e3)),await this.start(!0);}catch(t){m.error(`Restart failed: ${t.message}`),this.reconnectAttempts<this.maxReconnectAttempts&&this.scheduleReconnect();}}async stop(){m.info("Stopping bot..."),await this.cleanup();}registerCommand(e){this.commandSystem.register(e);}unregisterCommand(e){return this.commandSystem.unregister(e)}getCommand(e){return this.commandSystem.findCommand(e)}getAllCommands(){return this.commandSystem.getAll()}useMiddleware(e){this.commandSystem.use(e);}clearCooldowns(){this.commandSystem.clearCooldowns();}getOwners(){return this.config.owners}isConnected(){return this.isRunning&&this.sock!==null&&this.sock.user!==void 0}},gn=n=>new K(n);
export{K as WhatsAppBot,gn as createWhatsAppBot};//# sourceMappingURL=index.mjs.map
//# sourceMappingURL=index.mjs.map